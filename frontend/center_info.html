<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω—Ç—Ä–µ ‚Äî –†–∞–∑–≤–∏–¢–∞–π–º</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="page-root">
<header class="app-header">
  <div class="container app-header-inner">
    <div class="logo-block">
      <img src="assets/logo.png" alt="–†–∞–∑–≤–∏–¢–∞–π–º" class="logo-image" />
      <div class="logo-texts">
        <div class="logo-text-main">–†–∞–∑–≤–∏–¢–∞–π–º</div>
        <div class="logo-text-sub">—É–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Å–µ–º—å–∏</div>
      </div>
    </div>
    <nav class="nav-links">
      <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="search.html">–ù–∞–π—Ç–∏ –∑–∞–Ω—è—Ç–∏—è</a>
      <span id="auth-links">
        <!-- –°—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –ª–∏–±–æ –í–æ–π—Ç–∏, –ª–∏–±–æ —Å—Å—ã–ª–∫–∞ –≤ –õ–ö -->
      </span>
    </nav>
  </div>
</header>

<main class="page-parent" style="padding-top:24px;">
  <div class="container">
    <div id="center-info-card" class="split-card">
      –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ü–µ–Ω—Ç—Ä–µ...
    </div>

    <section style="margin-top:24px;">
      <h2 class="section-title">–í—Å–µ –∑–∞–Ω—è—Ç–∏—è —Ü–µ–Ω—Ç—Ä–∞</h2>
      <div id="center-activities-list" class="activities-list-grid">
        <!-- —Å—é–¥–∞ –ø—Ä–∏–¥—É—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä—É–∂–∫–æ–≤ -->
      </div>
    </section>
  </div>
</main>

<footer class="app-footer">
  <div class="container app-footer-inner">
    <div>¬© 2025 –†–∞–∑–≤–∏–¢–∞–π–º.</div>
    <div class="footer-links">
      <a href="#">–û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</a>
      <a href="#">–î–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π</a>
      <a href="#">–î–ª—è —Ü–µ–Ω—Ç—Ä–æ–≤</a>
      <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
    </div>
  </div>
</footer>

<script>
  const API_BASE = "http://localhost:5000";
  let CURRENT_USER = null;
  let CURRENT_CENTER_ID = null;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  function checkAuth() {
    const authLinks = document.getElementById("auth-links");
    try {
      const userData = localStorage.getItem("razvitime_user");
      CURRENT_USER = userData ? JSON.parse(userData) : null;
      
      if (CURRENT_USER && CURRENT_USER.role === "parent") {
        authLinks.innerHTML = `<a href="parent.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>`;
      } else {
        authLinks.innerHTML = `<a href="auth.html">–í–æ–π—Ç–∏</a>`;
      }
    } catch (e) {
      authLinks.innerHTML = `<a href="auth.html">–í–æ–π—Ç–∏</a>`;
    }
  }

  function getCenterId() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  
  console.log('URL params:', window.location.search);
  console.log('Extracted ID:', id);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –≤–∞–ª–∏–¥–Ω—ã–π
  if (!id) {
    console.error('No center ID provided');
    showError('–ù–µ —É–∫–∞–∑–∞–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—Ç—Ä–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –ø–æ–∏—Å–∫—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–Ω—Ç—Ä.');
    return null;
  }
  
  if (id === 'undefined' || id === 'null') {
    console.error('Invalid center ID:', id);
    showError('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—Ç—Ä–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –ø–æ–∏—Å–∫—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–Ω—Ç—Ä.');
    return null;
  }
  
  const numericId = parseInt(id, 10);
  if (isNaN(numericId)) {
    console.error('Center ID is not a number:', id);
    showError('–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—Ç—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –ø–æ–∏—Å–∫—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–Ω—Ç—Ä.');
    return null;
  }
  
  if (numericId <= 0) {
    console.error('Center ID is not positive:', numericId);
    showError('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—Ç—Ä–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –ø–æ–∏—Å–∫—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–Ω—Ç—Ä.');
    return null;
  }
  
  CURRENT_CENTER_ID = numericId;
  console.log('Valid center ID:', CURRENT_CENTER_ID);
  return CURRENT_CENTER_ID;
}

  function showError(message, showBackLink = true) {
    const infoBox = document.getElementById("center-info-card");
    const listBox = document.getElementById("center-activities-list");
    
    const backUrl = CURRENT_USER && CURRENT_USER.role === "parent" ? "parent.html#search" : "search.html";
    
    infoBox.innerHTML = `
      <div class="error-state" style="text-align: center; padding: 40px 20px; color: #666;">
        <h3 style="color: #d32f2f; margin-bottom: 12px;">–û—à–∏–±–∫–∞</h3>
        <p>${message}</p>
        ${showBackLink ? `<a href="${backUrl}" class="btn btn-primary" style="margin-top: 16px; display: inline-block;">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–∏—Å–∫—É</a>` : ''}
      </div>
    `;
    
    if (listBox) {
      listBox.innerHTML = '';
    }
  }

  function renderCenterInfo(center, activities) {
    const infoBox = document.getElementById("center-info-card");
    const listBox = document.getElementById("center-activities-list");

    if (!center) {
      showError("–¶–µ–Ω—Ç—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
      return;
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω—Ç—Ä–µ
    infoBox.innerHTML = `
      <h1 class="section-title">${center.name || '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</h1>
      <p class="section-subtitle">${center.city || ''}${
        center.address ? ' ¬∑ ' + center.address : ''
      }</p>

      <div style="margin-top:12px;">
        <h3>–û —Ü–µ–Ω—Ç—Ä–µ</h3>
        <p>${center.description || "–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ."}</p>
      </div>

      <div style="margin-top:12px;">
        <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
        <ul class="split-card-steps">
          ${center.phone ? `<li>–¢–µ–ª–µ—Ñ–æ–Ω: <a href="tel:${center.phone}">${center.phone}</a></li>` : ''}
          ${center.whatsapp ? `<li>WhatsApp: ${center.whatsapp}</li>` : ''}
          ${center.website ? `<li>–°–∞–π—Ç: <a href="${center.website}" target="_blank">${center.website}</a></li>` : ''}
          ${center.instagram ? `<li>Instagram: <a href="https://instagram.com/${center.instagram.replace('@', '')}" target="_blank">${center.instagram}</a></li>` : ''}
        </ul>
      </div>
    `;

    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ –∑–∞–Ω—è—Ç–∏–π
    if (!activities || !activities.length) {
      listBox.innerHTML = '<p class="no-data" style="text-align: center; color: #666; padding: 40px 20px; font-style: italic;">–í —ç—Ç–æ–º —Ü–µ–Ω—Ç—Ä–µ –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π.</p>';
    } else {
      listBox.innerHTML = activities
        .map(activity => `
          <article class="activity-card" style="transition: transform 0.2s ease;">
            <div class="activity-main">
              <h3>${activity.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
              <div class="activity-meta">
                ${activity.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}${
                  activity.min_age || activity.max_age
                    ? ` ¬∑ ${activity.min_age || '?'}‚Äì${activity.max_age || '?'} –ª–µ—Ç`
                    : ''
                }
              </div>
              <p class="activity-desc">
                ${activity.description ? 
                  (activity.description.length > 140 ? 
                    activity.description.slice(0, 140) + '...' : 
                    activity.description
                  ) : 
                  '–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ.'
                }
              </p>
              ${CURRENT_USER && CURRENT_USER.role === "parent" ? `
                <div style="margin-top: 12px;">
                  <button class="btn btn-primary btn-sm" onclick="enrollToActivity(${activity.id})">
                    üìù –ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ–±–µ–Ω–∫–∞
                  </button>
                </div>
              ` : ''}
            </div>
          </article>
        `)
        .join('');
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ
  async function enrollToActivity(activityId) {
    if (!CURRENT_USER || CURRENT_USER.role !== "parent") {
      alert('–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è');
      window.location.href = 'auth.html#parent';
      return;
    }

    try {
      // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏–º –≥—Ä—É–ø–ø—ã –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è
      const groupsRes = await fetch(`${API_BASE}/api/public/activities/${activityId}/groups`);
      const groups = await groupsRes.json();

      if (!groups || !groups.length) {
        alert('–î–ª—è —ç—Ç–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø');
        return;
      }

      // –ü–æ–ª—É—á–∏–º —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π —Ä–æ–¥–∏—Ç–µ–ª—è
      const kidsRes = await fetch(`${API_BASE}/api/parent/kids?parentId=${CURRENT_USER.parent_id}`);
      const kids = await kidsRes.json();

      if (!kids || !kids.length) {
        alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–µ–π –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ');
        window.location.href = 'parent.html#kids';
        return;
      }

      // –ü–æ–∫–∞–∂–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ä–µ–±–µ–Ω–∫–∞ –∏ –≥—Ä—É–ø–ø—ã
      showEnrollmentDialog(activityId, groups, kids);
      
    } catch (error) {
      console.error('Enrollment error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ');
    }
  }

  function showEnrollmentDialog(activityId, groups, kids) {
    const dialog = document.createElement('div');
    dialog.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    `;
    
    dialog.innerHTML = `
      <div style="background: white; padding: 24px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <h3 style="margin-top: 0;">–ó–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ</h3>
        
        <div class="form-group">
          <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±–µ–Ω–∫–∞:</label>
          <select id="enroll-kid-select" class="filter-select" style="width: 100%; margin-top: 8px;">
            ${kids.map(kid => `<option value="${kid.id}">${kid.full_name}</option>`).join('')}
          </select>
        </div>
        
        <div class="form-group" style="margin-top: 16px;">
          <label>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É:</label>
          <select id="enroll-group-select" class="filter-select" style="width: 100%; margin-top: 8px;">
            ${groups.map(group => `
              <option value="${group.id}">
                ${group.name || '–ì—Ä—É–ø–ø–∞'} - ${getWeekdayName(group.weekday)} ${group.start_time?.slice(0, 5)}-${group.end_time?.slice(0, 5)}
              </option>
            `).join('')}
          </select>
        </div>
        
        <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
          <button class="btn btn-secondary btn-sm" onclick="this.closest('div[style]').remove()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary btn-sm" id="confirm-enroll-btn">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(dialog);
    
    document.getElementById('confirm-enroll-btn').addEventListener('click', async () => {
      const kidId = document.getElementById('enroll-kid-select').value;
      const groupId = document.getElementById('enroll-group-select').value;
      
      await confirmEnrollment(kidId, groupId);
      dialog.remove();
    });
  }

  async function confirmEnrollment(kidId, groupId) {
    try {
      const response = await fetch(`${API_BASE}/api/parent/enroll`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          kid_id: parseInt(kidId),
          group_id: parseInt(groupId)
        })
      });

      const result = await response.json();

      if (response.ok) {
        alert('–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –¶–µ–Ω—Ç—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
      } else {
        alert(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏');
      }
    } catch (error) {
      console.error('Enrollment error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏');
    }
  }

  function getWeekdayName(weekday) {
    const days = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    return days[weekday] || '--';
  }

  async function loadCenterInfo() {
  console.log('=== Starting center info load ===');
  const centerId = getCenterId();
  
  if (!centerId) {
    console.log('=== No valid center ID, stopping ===');
    return;
  }

  console.log('Loading center with ID:', centerId);

  try {
    const centerUrl = `${API_BASE}/api/public/centers/${centerId}`;
    const activitiesUrl = `${API_BASE}/api/public/centers/${centerId}/activities`;
    
    console.log('Fetching from:', centerUrl);
    console.log('Fetching from:', activitiesUrl);

    const [centerRes, activitiesRes] = await Promise.all([
      fetch(centerUrl),
      fetch(activitiesUrl)
    ]);

    console.log('Center response status:', centerRes.status);
    console.log('Activities response status:', activitiesRes.status);

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –æ —Ü–µ–Ω—Ç—Ä–µ
    if (!centerRes.ok) {
      if (centerRes.status === 404) {
        throw new Error("–¶–µ–Ω—Ç—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö");
      } else {
        throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${centerRes.status}`);
      }
    }

    const center = await centerRes.json();
    console.log('Center data loaded:', center);
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –æ –∑–∞–Ω—è—Ç–∏—è—Ö
    let activities = [];
    if (activitiesRes.ok) {
      activities = await activitiesRes.json();
      console.log('Activities data loaded:', activities);
      // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ activities - –º–∞—Å—Å–∏–≤
      if (!Array.isArray(activities)) {
        console.warn('Activities is not array:', activities);
        activities = [];
      }
    } else {
      console.warn('Activities fetch failed:', activitiesRes.status);
    }

    renderCenterInfo(center, activities);
    
  } catch (error) {
    console.error('Center load error:', error);
    showError(error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω—Ç—Ä–µ");
  }
  
  console.log('=== Finished center info load ===');
}

  document.addEventListener("DOMContentLoaded", function() {
    checkAuth();
    loadCenterInfo();
  });
</script>
</body>
</html>